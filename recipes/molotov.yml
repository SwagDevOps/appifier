app: Molotov

ingredients:
  script:
    - set -eux
    # cleanup --------------------------------------------------------
    - rm -rf *.gz *.png *.sh VERSION *.part squashfs-root/
    # script file -----------------------------------------------------
    - SCRIPT=./ingredients.sh
    - cat > "${SCRIPT}" << EOF
    - set -eux
    # variables ------------------------------------------------------
    - MANIFEST_URL='https://desktop-auto-upgrade.molotov.tv/linux/manifest.json'
    - CONTENTS=\$(curl -kL "\${MANIFEST_URL}")
    - VERSION=\$(echo "\${CONTENTS}" | jq -r '.version' | sed 's/^v//')
    - DOWNLOAD_URL=\$(echo "\${CONTENTS}" | jq -r '.url' | sed 's/^v//')
    - FILE=\$(head -10 /dev/urandom | tr -cd '[:alnum:]' | cut -c -32).part
    # ensure variables -----------------------------------------------
    - test -n "\${VERSION}"
    - test -n "\${DOWNLOAD_URL}"
    # output files ---------------------------------------------------
    - echo "\${VERSION}" > VERSION
    - wget -c --trust-server-names --no-check-certificate "\${DOWNLOAD_URL}" -O "\${FILE}"
    - chmod +x "\${FILE}"
    - ./"\${FILE}" --appimage-extract
    - rm -fv "\${FILE}"
    # ensure extracted directory -------------------------------------
    - test -d squashfs-root
    # execution ------------------------------------------------------
    - EOF
    - /usr/bin/env sh "${SCRIPT}"

script:
  - set -eux
  - rm -rf ./*/
  - mv -v ../squashfs-root/* .
  - rm -fv molotov.png
  - cp usr/share/icons/hicolor/1024x1024/apps/molotov.png molotov.png

integration:
  name: Molotov
  executable: molotov
  desktop:
    name: Molotov
    override:
      'Desktop Entry':
        Exec: '{{executable.path}} %u'
        Icon: '{{icon.path}}'
