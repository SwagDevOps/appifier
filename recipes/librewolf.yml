app: LibreWolf

ingredients:
  script:
    - set -eux
    # cleanup --------------------------------------------------------
    - rm -rf *.gz *.png *.sh VERSION *.part squashfs-root/
    # script file -----------------------------------------------------
    - SCRIPT=./ingredients.sh
    - cat > "${SCRIPT}" << EOF
    - set -eux
    # variables ------------------------------------------------------
    - ARCH=x86_64
    - INSTALL_URL=https://librewolf.net/installation/linux/
    - REGEXP=\$(printf 'href="https://gitlab.com/api/v4/projects/24386000/packages/generic/librewolf/[0-9]+.*/LibreWolf\.%s.AppImage"' "\${ARCH}")
    - DOWNLOAD_URL=\$(curl "\${INSTALL_URL}" | grep -Eo "\${REGEXP}" | perl -pe 's#^href="##'| perl -pe 's#\.AppImage".*#.AppImage#')
    - VERSION=\$(echo "\${DOWNLOAD_URL}" | awk -F '/' '{print \$11}')
    - FILE=\$(head -10 /dev/urandom | tr -cd '[:alnum:]' | cut -c -32).part
    # ensure version -------------------------------------------------
    - test -n "\${VERSION}"
    # output files ---------------------------------------------------
    - echo "\${VERSION}" > VERSION
    # download and extract file --------------------------------------
    - wget -c --trust-server-names --no-check-certificate "\${DOWNLOAD_URL}" -O "\${FILE}"
    - chmod +x "\${FILE}"
    - ./"\${FILE}" --appimage-extract
    - rm -fv "\${FILE}"
    # ensure extracted directory -------------------------------------
    - test -d squashfs-root
    # execution ------------------------------------------------------
    - EOF
    - /usr/bin/env sh "${SCRIPT}"

script:
  - set -eux
  - rm -rf ./*/
  - mv -v ../squashfs-root/* .

integration:
  name: LibreWolf
  executable: librewolf
  desktop:
    name: librewolf
    override:
      'Desktop Entry':
        StartupWMClass: librewolf
        Exec: '{{executable.path}} %u'
        Icon: '{{icon.path}}'
        Comment: 'A fork of Firefox, focused on privacy, security and freedom.'
      'Desktop Action new-window':
        Exec: '{{executable.path}} %u'
      'Desktop Action new-private-window':
        Exec: '{{executable.path}} --private-window %u'
      'Desktop Action profilemanager':
        Exec: '{{executable.path}} --ProfileManager %u'
