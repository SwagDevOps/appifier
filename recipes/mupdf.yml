# MuPDF is a lightweight PDF and XPS viewer and parser/rendering library.
#
# @see https://mupdf.com/downloads/
# @see https://github.com/m59peacemaker/mupdf-appimage
app: MuPDF

ingredients:
  script:
    - set -eux
    # cleanup --------------------------------------------------------
    - rm -rf *.gz *.svg *.sh VERSION *.part mupdf*/ releases target
    # script file -----------------------------------------------------
    - SCRIPT=./ingredients.sh
    - cat > "${SCRIPT}" << EOF
    - set -eux
    - # variables -----------------------------------------------------
    - SHORTNAME=mupdf
    - RELEASES_URL='https://mupdf.com/downloads/'
    - ICON_URL='https://upload.wikimedia.org/wikipedia/commons/c/ce/MuPDF.svg'
    - PLATFORM=\$(uname -i)
    - FILE=\$(head -10 /dev/urandom | tr -cd '[:alnum:]' | cut -c -32).part
    - # set plateform used in dowmload url ----------------------------
    - test "\${PLATFORM}" = x86_64 && PLATFORM=amd64 ||:
    - echo "\${PLATFORM}" > target
    - # output files --------------------------------------------------
    - wget --trust-server-names -c "\${ICON_URL}" -O "\${SHORTNAME}.svg"
    - wget -qO- "\${RELEASES_URL}" | grep -Eo 'archive/mupdf-([0-9]+\..*)-linux(\")*' | sed 's/\".*//g' | grep -- "-linux-\${PLATFORM}" > releases
    - # prepare download URL ------------------------------------------
    - DLD_PATH=\$(head -1 releases)
    - DLD_URL="\${RELEASES_URL}/\${DLD_PATH}"
    - VERSION=\$(echo "\${DLD_PATH}" | grep -Eo '[0-9]+\.[0-9]+(\.[0-9]+)*')
    - # output VERSION ------------------------------------------------
    - test "\${VERSION}" != '' # ensure VERSION is not empty
    - echo "\${VERSION}" > VERSION
    - # ensure DLD_PATH is not empty, then download -------------------
    - echo "\${DLD_PATH}" | grep -E '[a-z]'
    - wget --trust-server-names "\${DLD_URL}" -O "\${FILE}"
    - tar -xvf "\${FILE}"
    - EOF
    - /usr/bin/env sh "${SCRIPT}"

script:
  - set -eux
  # desktop -------------------------------------------------------
  - cat > "mupdf.desktop" << EOF
  - [Desktop Entry]
  - Version=1.0
  - Name=MuPDF
  - Comment=MuPDF is a lightweight PDF viewer
  - Exec=mupdf %U
  - Terminal=false
  - Type=Application
  - Icon=mupdf
  - Categories=Office;Viewer;Graphics;2DGraphics;VectorGraphics;
  - MimeType=application/pdf;application/x-pdf;application/x-cbz;application/oxps;application/vnd.ms-xpsdocument;image/jpeg;image/pjpeg;image/png;image/tiff;image/x-tiff;
  - StartupNotify=false
  - StartupWMClass=mupdf
  - EOF
  # files ---------------------------------------------------------
  - cp -v '../mupdf.svg' .
  - mkdir -p usr/share/applications
  - cp -v mupdf.desktop usr/share/applications
  - cp -v ../*/mupdf usr/bin
  - cp -v ../*/docs/mupdf.txt README || true

integration:
  name: MuPDF
  executable: mupdf
  desktop:
    name: MuPDF
    override:
      'Desktop Entry':
        TryExec: '{{executable.path}}'
        Exec: '{{executable.path}} %U'
        Icon: '{{icon.path}}'
