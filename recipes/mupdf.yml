# MuPDF is a lightweight PDF and XPS viewer and parser/rendering library.
app: MuPDF

ingredients:
  script:
    - set -eux
    # cleanup --------------------------------------------------------
    - rm -rf *.gz *.svg *.sh VERSION *.part mupdf*/
    # script file -----------------------------------------------------
    - SCRIPT=./ingredients.sh
    - cat > "${SCRIPT}" << EOF
    - set -eux
    - # variables -----------------------------------------------------
    - SHORTNAME=mupdf
    - RELEASES_URL='https://mupdf.com/downloads/'
    - ICON_URL='https://upload.wikimedia.org/wikipedia/commons/c/ce/MuPDF.svg'
    - PLATFORM=\$(uname -i)
    - FILE=\$(head -10 /dev/urandom | tr -cd '[:alnum:]' | cut -c -32).part
    - # set plateform used in dowmload url ----------------------------
    - test "\${PLATFORM}" = x86_64 && PLATFORM=amd64 ||:
    - echo "\${PLATFORM}" > target
    - # output files --------------------------------------------------
    - wget --trust-server-names -c "\${ICON_URL}" -O "\${SHORTNAME}.svg"
    - wget -qO- "\${RELEASES_URL}" | grep -Eo 'archive/mupdf-([0-9]+\..*)-linux(\")*' | sed 's/\".*//g' | grep -- "-linux-\${PLATFORM}" > releases
    - # prepare download URL ------------------------------------------
    - DLD_PATH=\$(head -1 releases)
    - DLD_URL="\${RELEASES_URL}/\${DLD_PATH}"
    - VERSION=\$(echo "\${DLD_PATH}" | grep -Eo '[0-9]+\.[0-9]+(\.[0-9]+)*')
    - # output VERSION ------------------------------------------------
    - test "\${VERSION}" != '' # ensure VERSION is not empty
    - echo "\${VERSION}" > VERSION
    - # ensure DLD_PATH is not empty, then download -------------------
    - echo "\${DLD_PATH}" | grep -E '[a-z]'
    - wget --trust-server-names "\${DLD_URL}" -O "\${FILE}"
    - tar -xvf "\${FILE}"
    - EOF
    - /usr/bin/env sh "${SCRIPT}"

script:
  - set -eux
  # desktop -------------------------------------------------------
  - cat > "mupdf.desktop" << EOF
  - [Desktop Entry]
  - Version=1.0
  - Name=MuPDF
  - Comment=MuPDF is a lightweight PDF viewer
  - Exec=mupdf %U
  - Terminal=false
  - Type=Application
  - Icon=mupdf
  - Categories=Office;Viewer;Graphics;2DGraphics;VectorGraphics;
  - MimeType=application/pdf;application/x-bzpdf;application/x-gzpdf;application/x-xzpdf;application/x-ext-pdf;application/postscript;application/x-bzpostscript;application/x-gzpostscript;image/x-eps;image/x-bzeps;image/x-gzeps;application/x-ext-ps;application/x-ext-eps;application/illustrator;application/x-dvi;application/x-bzdvi;application/x-gzdvi;application/x-ext-dvi;image/vnd.djvu+multipage;application/x-ext-djv;application/x-ext-djvu;image/tiff;application/x-cbr;application/x-cbz;application/x-cb7;application/x-cbt;application/x-ext-cbr;application/x-ext-cbz;application/x-ext-cb7;application/x-ext-cbt;application/vnd.comicbook+zip;application/vnd.comicbook-rar;application/oxps;application/vnd.ms-xpsdocument;
  - StartupNotify=false
  - StartupWMClass=mupdf
  - EOF
  # files ---------------------------------------------------------
  - cp -v '../mupdf.svg' .
  - mkdir -p usr/share/applications
  - cp -v mupdf.desktop usr/share/applications
  - cp -v ../*/mupdf usr/bin
  - cp -v ../*/docs/mupdf.txt README || true

integration:
  name: MuPDF
  executable: mupdf
  desktop:
    name: MuPDF
    override:
      'Desktop Entry':
        TryExec: '{{executable.path}}'
        Exec: '{{executable.path}} %U'
        Icon: '{{icon.path}}'
