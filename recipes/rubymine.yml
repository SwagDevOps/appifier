app: RubyMine

ingredients:
  script:
    - set -eux
    - SHORTNAME=rubymine
    - FILE=$(head -10 /dev/urandom | tr -cd '[:alnum:]' | cut -c -32).part
    # cleanup --------------------------------------------------------
    - rm -rf *.png *.sh VERSION *.part *.gz
    # download -------------------------------------------------------
    - DLD=$(curl -LIs -o /dev/null -w %{url_effective} 'https://data.services.jetbrains.com/products/download?code=RM&platform=linux')
    - test -n "${DLD}"
    - basename "${DLD}" | cut -d- -f2 | sed -e "s/.tar.gz//" > VERSION
    - wget --trust-server-names "${DLD}" -O "${FILE}"
    - mv "${FILE}" "${SHORTNAME}.tar.gz"

script:
  - set -eux
  - SHORTNAME=rubymine
  - FULLNAME=RubyMine
  # build ------------------------------------------------------------
  - mkdir -p opt/$SHORTNAME
  - tar zxvf ../${SHORTNAME}.tar.gz --directory "opt/${SHORTNAME}" --strip-components=1
  - ln -sr opt/$SHORTNAME/bin/$SHORTNAME.sh usr/bin/$SHORTNAME
  - ln opt/$SHORTNAME/bin/$SHORTNAME.svg .
  - cat > $FULLNAME.desktop << EOF
  - [Desktop Entry]
  - Version=1.0
  - Type=Application
  - Name=$FULLNAME
  - Icon=$SHORTNAME
  - Exec=$SHORTNAME %u
  - Comment=The smartest Ruby IDE
  - Categories=Development;IDE;
  - Terminal=false
  - StartupWMClass=jetbrains-rubymine
  - EOF
  - rm -rf opt/*/jbr/legal/*.desktop
  - rm -rf opt/*/bin/fsnotifier-arm
  - rm -rf opt/*/bin/fsnotifier

integration:
  name: RubyMine
  executable: rubymine
  desktop:
    name: 'jetbrains-rubymine'
    override:
      'Desktop Entry':
        Exec: '{{executable.path}} %u'
        Icon: '{{icon.path}}'