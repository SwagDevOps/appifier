app: WezTerm

ingredients:
  packages:
    - wezterm
  script:
    - set -eux
    - rm -rf *.sh *.deb *.svg *.png *.AppImage VERSION
    # script file -----------------------------------------------------
    - SCRIPT=./ingredients.sh
    - cat > "${SCRIPT}" << EOF
    - set -eux
    # downloads ------------------------------------------------------
    - DOCU_URL='https://wezfurlong.org/wezterm/install/linux.html'
    - ICON_URL='https://raw.githubusercontent.com/wez/wezterm/main/assets/icon/wezterm-icon.svg'
    # variables ------------------------------------------------------
    - DOWNLOAD_URL=\$(curl -L "\${DOCU_URL}" | grep -Eo 'curl.*\s+(https://.*\.AppImage)\$' | head -1 | awk '{print \$NF}')
    - FILE=\$(head -10 /dev/urandom | tr -cd '[:alnum:]' | cut -c -32).part
    - VERSION=\$(basename -- "\$DOWNLOAD_URL" | perl -pe 's#^WezTerm-##' | perl -pe 's#-Ubuntu[0-9]{2}\.[0-9]{2}.AppImage\$##')
    # ensure version -------------------------------------------------
    - test -n "\${VERSION}"
    # output files ---------------------------------------------------
    - echo "\${VERSION}" > VERSION
    - wget -c --trust-server-names --no-check-certificate "\${ICON_URL}" -O "wezterm.svg"
    # download and extract file --------------------------------------
    - wget -c --trust-server-names --no-check-certificate "\${DOWNLOAD_URL}" -O "\${FILE}"
    - chmod +x "\${FILE}"
    - ./"\${FILE}" --appimage-extract
    - rm -fv "\${FILE}"
    # ensure extracted directory -------------------------------------
    - test -d squashfs-root
    # execution ------------------------------------------------------
    - EOF
    - /usr/bin/env sh "${SCRIPT}"

script:
  - set -eux
  - rm -rf ./*/
  - mv -v ../squashfs-root/* .
  - # files tweaks -----------------------------------------------------
  - cp -fv ../wezterm.svg .DirIcon

integration:
  name: WezTerm
  executable: wezterm
  desktop:
    name: wezterm
    override:
      'Desktop Entry':
        TryExec: '{{executable.path}}'
        Exec: '{{executable.path}} start --cwd .'
        Icon: '{{icon.path}}'
