app: Caprine

ingredients:
  packages:
    - caprine
  script:
    - set -eux
    - rm -rf *.sh *.deb *.svg *.png VERSION
    # script file -----------------------------------------------------
    - SCRIPT=./ingredients.sh
    - cat > "${SCRIPT}" << EOF
    - set -eux
    # variables ------------------------------------------------------
    - BASE_URL='https://github.com/sindresorhus/caprine'
    - ICON_URL='https://raw.githubusercontent.com/sindresorhus/caprine/master/static/Icon.png'
    - RELEASE=\$(curl -L "\${BASE_URL}/releases" | grep -Eo '/releases/download/.*amd64\.deb' | head -1)
    - URL="\${BASE_URL}\${RELEASE}"
    - VERSION=\$(basename -- "\${RELEASE}" | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+')
    # output files ---------------------------------------------------
    - echo "\${VERSION}" > VERSION
    - wget --trust-server-names -c "\$ICON_URL" -O caprine.png
    - wget --trust-server-names -c "\$URL" -O "caprine-\${VERSION}.deb"
    - EOF
    - /usr/bin/env sh "${SCRIPT}"

script:
  - set -eux
  # desktop file -----------------------------------------------------
  - cat > caprine.desktop << EOF
  - [Desktop Entry]
  - Name=Caprine
  - Exec=caprine %U
  - Terminal=false
  - Type=Application
  - Icon=caprine
  - StartupWMClass=Caprine
  - Comment=Elegant Facebook Messenger desktop app
  - Categories=GNOME;GTK;Network;InstantMessaging;
  - EOF
  # files tweaks -----------------------------------------------------
  - cp ../caprine.png .
  - ln -sfvr opt/Caprine/caprine usr/bin/caprine

integration:
  name: Caprine
  executable: caprine
  desktop:
    name: caprine
    override:
      'Desktop Entry':
        Exec: '{{executable.path}} %U'
        Icon: '{{icon.path}}'
