# @see https://build.opensuse.org/package/view_file/openSUSE:Leap:15.0/chromium/chromium-browser.desktop
# @see https://github.com/scheib/chromium-latest-linux/blob/4f4e9b85ea02a109e071452de936389cc2fd7376/update.sh

app: Chromium_Canary
lowerapp: chromium-browser
arch: x86_64

ingredients:
  dist: trusty
  sources:
    - deb http://archive.ubuntu.com/ubuntu/ trusty main universe
  packages: []
  script:
    - set -eu
    # cleanup --------------------------------------------------------
    - rm -rf VERSION *.zip *.png *.svg *.sh *.deb
    # variables ------------------------------------------------------
    - LOWERAPP=chromium-browser
    - ICON_URL='https://upload.wikimedia.org/wikipedia/commons/5/5f/Chromium_11_Logo.svg'
    - REVISION=$(curl -sS 'https://www.googleapis.com/download/storage/v1/b/chromium-browser-snapshots/o/Linux_x64%2FLAST_CHANGE?alt=media')
    - DLD="https://www.googleapis.com/download/storage/v1/b/chromium-browser-snapshots/o/Linux_x64%2F${REVISION}%2Fchrome-linux.zip?alt=media"
    # output files ---------------------------------------------------
    - wget --trust-server-names -c "${ICON_URL}" -O "${LOWERAPP}.svg"
    - wget --trust-server-names -c "$DLD" -O "${REVISION}.zip"
    - unzip -oq "${REVISION}.zip"
    - echo "$(date +'%Y.%m.%d').${REVISION}" > VERSION

script:
  - set -eu
  - # variables -----------------------------------------------------
  - LOWERAPP=chromium-browser
  - # desktop -------------------------------------------------------
  - cat > "${LOWERAPP}.desktop" << EOF
  - [Desktop Entry]
  - Version=1.0
  - Name=Chromium Canary
  - Comment=Browse the World Wide Web
  - GenericName=Web Browser
  - Exec=${LOWERAPP} %u
  - Terminal=false
  - X-MultipleArgs=false
  - Type=Application
  - Icon=${LOWERAPP}
  - StartupWMClass=chromium-browser
  - Categories=Network;WebBrowser;
  - MimeType=text/html;text/xml;application/xhtml+xml;x-scheme-handler/http;x-scheme-handler/https;
  - EOF
  # files ---------------------------------------------------------
  - cp "../${LOWERAPP}.svg" .
  - mkdir -p usr/share/applications
  - cp "${LOWERAPP}.desktop" usr/share/applications
  - mkdir -p "usr/share/${LOWERAPP}/"
  - cp -rfv ../chrome-linux/* "usr/share/${LOWERAPP}/"
  - rm -rfv xdg-mime xdg-settings chrome-wrapper
  - ln -sfvr "usr/share/${LOWERAPP}/chrome" "usr/bin/${LOWERAPP}"

integration:
  name: Chromium_Canary
  executable: chromium-browser
  desktop:
    name: chromium-browser
    override:
      'Desktop Entry':
        Exec: '{{executable.path}} %u'
        Icon: '{{icon.path}}'
